# Triggering metrics generation - version 1.1
name: Metrics
on:
  schedule: [{cron: "0 0 * * *"}]
  workflow_dispatch:
  push: {branches: ["master", "main"]}

jobs:
  # ──────────────────────────────────────────────
  #  Generate each plugin SVG
  #  Config source-of-truth: plugins/*.json
  # ──────────────────────────────────────────────
  metrics:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      # ──────────────────────────────────────────────
      #  Normal Versions
      # ──────────────────────────────────────────────

      - name: Generate isocalendar
        uses: lowlighter/metrics@latest
        with:
          filename: "metrics.plugin.isocalendar.fullyear.svg"
          token: "${{ secrets.METRICS_TOKEN }}"
          base: ""
          plugin_isocalendar: "yes"
          plugin_isocalendar_duration: "full-year"

      - name: Generate languages
        uses: lowlighter/metrics@latest
        with:
          filename: "metrics.plugin.languages.svg"
          token: "${{ secrets.METRICS_TOKEN }}"
          base: ""
          plugin_languages: "yes"
          plugin_languages_ignored: "html, css"
          plugin_languages_details: "bytes-size, percentage"
          plugin_languages_limit: 8

      - name: Generate leetcode
        uses: lowlighter/metrics@latest
        with:
          filename: "metrics.plugin.leetcode.svg"
          token: "${{ secrets.METRICS_TOKEN }}"
          base: ""
          plugin_leetcode: "yes"
          plugin_leetcode_user: "vOF31ss21z"
          plugin_leetcode_sections: "solved, skills, recent"

      - name: Generate lines
        uses: lowlighter/metrics@latest
        with:
          filename: "metrics.plugin.lines.svg"
          token: "${{ secrets.METRICS_TOKEN }}"
          base: ""
          plugin_lines: "yes"

      - name: Generate followup
        uses: lowlighter/metrics@latest
        with:
          filename: "metrics.plugin.followup.svg"
          token: "${{ secrets.METRICS_TOKEN }}"
          base: ""
          plugin_followup: "yes"
          plugin_followup_sections: "repositories"

      - name: Generate stars
        uses: lowlighter/metrics@latest
        with:
          filename: "metrics.plugin.stars.svg"
          token: "${{ secrets.METRICS_TOKEN }}"
          base: ""
          plugin_stars: "yes"
          plugin_stars_limit: 4

      - name: Generate achievements
        uses: lowlighter/metrics@latest
        with:
          filename: "metrics.plugin.achievements.svg"
          token: "${{ secrets.METRICS_TOKEN }}"
          base: ""
          plugin_achievements: "yes"
          plugin_achievements_display: "compact"
          plugin_achievements_threshold: "C"

      # ──────────────────────────────────────────────
      #  Clean Versions (Optimized, No Headers)
      # ──────────────────────────────────────────────

      - name: Generate isocalendar (clean)
        uses: lowlighter/metrics@latest
        with:
          filename: "metrics.plugin.isocalendar.fullyear.clean.svg"
          token: "${{ secrets.METRICS_TOKEN }}"
          base: ""
          plugin_isocalendar: "yes"
          plugin_isocalendar_duration: "full-year"
          config_optimize: "yes"
          config_padding: "0, 8"
          extras_css: "h2 { display: none; }"

      - name: Generate languages (clean)
        uses: lowlighter/metrics@latest
        with:
          filename: "metrics.plugin.languages.clean.svg"
          token: "${{ secrets.METRICS_TOKEN }}"
          base: ""
          plugin_languages: "yes"
          plugin_languages_ignored: "html, css"
          plugin_languages_details: "bytes-size, percentage"
          plugin_languages_limit: 8
          config_optimize: "yes"
          config_padding: "0, 8"
          extras_css: "h2 { display: none; }"

      - name: Generate leetcode (clean)
        uses: lowlighter/metrics@latest
        with:
          filename: "metrics.plugin.leetcode.clean.svg"
          token: "${{ secrets.METRICS_TOKEN }}"
          base: ""
          plugin_leetcode: "yes"
          plugin_leetcode_user: "vOF31ss21z"
          plugin_leetcode_sections: "solved, skills, recent"
          config_optimize: "yes"
          config_padding: "0, 8"
          extras_css: "h2 { display: none; }"

      - name: Generate stars (clean)
        uses: lowlighter/metrics@latest
        with:
          filename: "metrics.plugin.stars.clean.svg"
          token: "${{ secrets.METRICS_TOKEN }}"
          base: ""
          plugin_stars: "yes"
          plugin_stars_limit: 4
          config_optimize: "yes"
          config_padding: "0, 8"
          extras_css: "h2 { display: none; }"

      - name: Generate achievements (clean)
        uses: lowlighter/metrics@latest
        with:
          filename: "metrics.plugin.achievements.clean.svg"
          token: "${{ secrets.METRICS_TOKEN }}"
          base: ""
          plugin_achievements: "yes"
          plugin_achievements_display: "compact"
          plugin_achievements_threshold: "C"
          config_optimize: "yes"
          config_padding: "0, 8"
          extras_css: "h2 { display: none; }"

      - name: Generate lines (clean)
        uses: lowlighter/metrics@latest
        with:
          filename: "metrics.plugin.lines.clean.svg"
          token: "${{ secrets.METRICS_TOKEN }}"
          base: ""
          plugin_lines: "yes"
          config_optimize: "yes"
          config_padding: "0, 8"
          extras_css: "h2 { display: none; }"

      - name: Generate followup (clean)
        uses: lowlighter/metrics@latest
        with:
          filename: "metrics.plugin.followup.clean.svg"
          token: "${{ secrets.METRICS_TOKEN }}"
          base: ""
          plugin_followup: "yes"
          plugin_followup_sections: "repositories"
          config_optimize: "yes"
          config_padding: "0, 8"
          extras_css: "h2 { display: none; }"

      # ──────────────────────────────────────────────
      #  Sync & Update README
      # ──────────────────────────────────────────────

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      - name: Scrape picoCTF stats
        run: node picoctf-scraper.js spw

      - name: Generate README
        run: node generate-readme.js

      - name: Debug Workspace
        run: |
          ls -R
          echo "I was here" > I_WAS_HERE.txt
          [ -f picoctf-stats.json ] && cat picoctf-stats.json || echo "stats file not found"

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "chore: update metrics and README [skip ci]" || echo "No changes to commit"
          git push origin main
